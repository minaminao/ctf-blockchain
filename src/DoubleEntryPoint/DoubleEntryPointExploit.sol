// SPDX-License-Identifier: UNLICENSED
pragma solidity ^0.8.13;

import "./DoubleEntryPoint.sol";

function playerScript(address instanceAddress) {
    DetectionBot detectionBot = new DetectionBot();
    Forta forta = Forta(DoubleEntryPoint(instanceAddress).forta());
    forta.setDetectionBot(address(detectionBot));
    DoubleEntryPointExploit exploit = new DoubleEntryPointExploit();
    exploit.exploit(instanceAddress);
}

contract DoubleEntryPointExploit {
    function exploit(address instanceAddress) public {
        DoubleEntryPoint instance = DoubleEntryPoint(instanceAddress);
        Forta forta = instance.forta();
        DetectionBot detectionBot =
            DetectionBot(address(forta.usersDetectionBots(msg.sender)));
        detectionBot.setFortaAddress(address(instance.forta()));
    }
}

contract DetectionBot is IDetectionBot {
    address fortaAddress;

    function setFortaAddress(address fortaAddress_) public {
        fortaAddress = fortaAddress_;
    }

    function handleTransaction(address user, bytes calldata) external {
        Forta forta = Forta(fortaAddress);
        forta.raiseAlert(user);
    }
}
